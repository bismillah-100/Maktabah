name: Release Maktabah

on:
  push:
    tags:
      - "v*"
      - "V*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v1.0.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-26

    steps:
      # Checkout source
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}
          fetch-depth: 0

      # Pilih Xcode
      - name: Select Xcode 26.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.2"

      # Tentukan tag
      - name: Set Tag Name
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # Nama produk
      - name: Set Product Name
        id: vars
        run: echo "PRODUCT_NAME=Maktabah" >> $GITHUB_OUTPUT

      # Debug
      - name: Show Current Commit
        run: |
          git log -1 --oneline
          echo "Tag: ${{ steps.tag.outputs.TAG_NAME }}"

      # Build archive macOS
      - name: Build archive
        run: |
          xcodebuild archive \
            -project Maktabah.xcodeproj \
            -scheme Maktabah \
            -archivePath "build/Maktabah.xcarchive" \
            -configuration Release \
            -destination "generic/platform=macOS"

      # Ambil .app dan zip
      - name: Package app
        run: |
          mkdir -p build/app_staging
          cp -R "build/Maktabah.xcarchive/Products/Applications/Maktabah.app" build/app_staging/
          cd build/app_staging
          ZIP_NAME="${{ steps.vars.outputs.PRODUCT_NAME }}-${{ steps.tag.outputs.TAG_NAME }}.zip"
          zip -r "../${ZIP_NAME}" "Maktabah.app"

      # Upload ke GitHub Release
      - name: Upload Release Asset
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.TAG_NAME }}
          files: build/${{ steps.vars.outputs.PRODUCT_NAME }}-${{ steps.tag.outputs.TAG_NAME }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
